<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>태양광 발전량 계산 결과</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
    background: #f8fafc;
    margin: 0;
    padding: 20px; 
  }
  .container {
    max-width: 350px; /* ✅ 최종 전체 너비 350px로 조정 */
    margin: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }

  /* 요약표 */
  .summary-box {
    background:#f5f7ff;
    border:1px solid #d6dbff;
    border-radius:10px;
    padding:10px 15px;
    margin:0;
    max-width: 100%;
    width: 100%;
    font-size: 13px;
    box-shadow:0 2px 6px rgba(0,0,0,0.04);
    flex-grow: 0;
    flex-shrink: 0;
  }
  .summary-box h2 {
    text-align:center;
    color:#1d3557;
    font-size:16px;
    margin-bottom: 5px;
  }
  .summary-box table { width:100%; border-collapse:collapse; }
  .summary-box th {
    background:#e8ecff;
    color:#1d3557;
    text-align:left;
    padding:4px 8px;
    border-bottom:1px solid #dce2ff;
    font-weight:600;
    width:55%;
  }
  .summary-box td {
    text-align:right;
    padding:4px 8px;
    border-bottom:1px solid #edf0ff;
    color:#333;
    font-weight:500;
  }
  .summary-box tr:last-child th,
  .summary-box tr:last-child td { border-bottom:none; }

  /* 그래프 영역 */
  .chart-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex-grow: 1;
    min-width: 100%;
  }
  .chart-card {
    background: white;
    border-radius: 14px;
    padding: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  .chart-card h3 {
    text-align:center;
    color:#1d3557;
    font-size:14px;
    margin-bottom: 3px;
  }
  /* 캔버스 세로 길이 */
  .chart-card canvas {
    height: 16vh !important; /* ✅ 최종 세로 길이 16vh로 조정 */
    max-height: 900px !important;
    width: 100% !important;
  }

  /* 모바일 대응: 전체 너비 감소에 따라 분기점 조정 */
  @media (max-width: 420px) {
    .container {
      flex-direction: column;
      gap: 15px;
    }
    .chart-card canvas { height: 20vh !important; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="summary-box">
    <h2>발전량 시뮬레이션 결과</h2>
    <table id="summaryTable"></table>
  </div>

  <div class="chart-container">
    <div class="chart-card">
      <h3>월별 발전량 (kWh)</h3>
      <canvas id="monthlyChart"></canvas>
    </div>

    <div class="chart-card">
      <h3>월별 매출액 (원)</h3>
      <canvas id="revenueChart"></canvas>
    </div>

    <div class="chart-card">
      <h3>20년 누적 수익 (원)</h3>
      <canvas id="accumChart"></canvas>
    </div>
  </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const site = urlParams.get('site');
const width = parseFloat(urlParams.get('width'));
const height = parseFloat(urlParams.get('height'));
const power = parseFloat(urlParams.get('power'));
const invest = parseFloat(urlParams.get('invest')) || 0;
const support = parseFloat(urlParams.get('support')) || 0;

const siteData = {
  "산업단지": {
    area: 7718419,
    irradiance: {
      "1월": 36.1167916632637, "2월": 55.6968144538703, "3월": 94.7830864448928,
      "4월": 126.11394913181, "5월": 155.100681490681, "6월": 159.89038530079,
      "7월": 160.292749896046, "8월": 140.231920433173, "9월": 104.527127375401,
      "10월": 71.3669316620513, "11월": 41.0833948879698, "12월": 30.136668760777
    }
  },
  "주차장": {
    area: 241197,
    irradiance: {
      "1월": 28.6013706281546, "2월": 45.5446010734928, "3월": 81.5032748909017,
      "4월": 113.351159004195, "5월": 143.143665420168, "6월": 148.730656177913,
      "7월": 148.929582549517, "8월": 116.426167318056, "9월": 92.3191337237899,
      "10월": 60.2785524922634, "11월": 33.2715624798212, "12월": 23.7878350927661
    }
  },
  "철도 유휴부지": {
    area: 72040,
    irradiance: {
      "1월": 29.0993114732458, "2월": 48.1443882406552, "3월": 86.1475051850494,
      "4월": 117.571860513444, "5월": 146.572228430643, "6월": 151.802754562315,
      "7월": 151.850941097544, "8월": 131.468678784622, "9월": 96.0437754841264,
      "10월": 63.032589902433, "11월": 33.9140067853013, "12월": 23.6004359046563
    }
  }
};

// 단가 정보
const SMP = [137.91,119.49,134.4,125.9,126.35,125.99,132.46,145.79,138.78,117.2,112.26,116.58];
const REC = [77939,79323,79058,75584,74466,74916,75801,78753,79282,76866,75010,67159];
const pricePerKwh = 163;

const siteObj = siteData[site] || {};
const area = siteObj.area || 0;
const irradiance = siteObj.irradiance || {};
const panelArea = (width/1000)*(height/1000) || 0;
const moduleCount = panelArea > 0 ? Math.floor(area / panelArea) : 0;
const totalKW = moduleCount * (power/1000) || 0;

const months = Object.keys(irradiance);
const irradianceVals = Object.values(irradiance);

// 월별 발전량 (kWh) — 정수
const monthlyEnergy = irradianceVals.map(val => Math.round(totalKW * val));

// 월별 매출액 계산
const monthlyRevenue = monthlyEnergy.map((val, i) => 
  Math.round(val * (SMP[i] + (REC[i]/1000)))
);

// 절감액 및 손익분기점
const annualEnergy = monthlyEnergy.reduce((a,b)=>a+b,0);
const saving = Math.round(annualEnergy * pricePerKwh);
const breakeven = invest - support;

// 누적 수익 (20년)
const yearlyRevenue = monthlyRevenue.reduce((a,b)=>a+b,0);
const accumRevenue = Array.from({length:20},(_,i)=> (yearlyRevenue*(i+1)));

document.getElementById("summaryTable").innerHTML = `
  <tr><th>선택된 부지</th><td>${site || '-'}</td></tr>
  <tr><th>발전 가능 면적</th><td>${area ? area.toLocaleString() + ' ㎡' : '-'}</td></tr>
  <tr><th>모듈 수</th><td>${moduleCount ? moduleCount.toLocaleString() + ' 개' : '-'}</td></tr>
  <tr><th>총 발전용량</th><td>${totalKW ? totalKW.toLocaleString(undefined,{maximumFractionDigits:1}) + ' kW' : '-'}</td></tr>
  <tr><th>예상 연간 발전량</th><td>${annualEnergy ? annualEnergy.toLocaleString() + ' kWh' : '-'}</td></tr>
  <tr><th>절감 전기요금</th><td>${saving ? saving.toLocaleString() + ' 원/년' : '-'}</td></tr>
  <tr><th>손익분기점</th><td>${breakeven ? breakeven.toLocaleString() + ' 원' : '-'}</td></tr>
`;

// 공통 차트 옵션
const commonOpts = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    tooltip: { enabled: true, callbacks: { label: ctx => ctx.raw.toLocaleString() } },
    legend: { display: false }
  },
  scales: {
    x: {
      ticks: { 
        autoSkip: true, 
        maxRotation: 45, /* ✅ X축 라벨 회전 각도 45도로 설정 (찌그러짐 방지) */
        minRotation: 45, /* 찌그러짐 방지를 위해 minRotation도 동일하게 설정 */
        font: { 
          size: 13, 
          weight: 'normal'
        }
      }
    },
    y: {
      beginAtZero: true,
      ticks: { 
        callback: v => v.toLocaleString(),
        font: {
          size: 11
        }
      }
    }
  }
};

// 1. 월별 발전량 차트
new Chart(document.getElementById("monthlyChart"), {
  type: 'bar',
  data: { labels: months, datasets: [{
    data: monthlyEnergy,
    backgroundColor: '#1d3557',
    barPercentage:0.7,
    categoryPercentage:0.8
  }] },
  options: { ...commonOpts }
});

// 2. 월별 매출액 차트
new Chart(document.getElementById("revenueChart"), {
  type: 'bar',
  data: { labels: months, datasets: [{
    data: monthlyRevenue,
    backgroundColor: '#ff9f1c',
    barPercentage:0.7,
    categoryPercentage:0.8
  }] },
  options: { ...commonOpts }
});

// 3. 20년 누적 수익 차트
new Chart(document.getElementById("accumChart"), {
  type: 'bar',
  data: { 
    labels: Array.from({length:20},(_,i)=>`${i+1}년`),
    datasets: [
      {
        label:'누적 수익',
        data: accumRevenue,
        backgroundColor:'#90be6d',
        order: 1,
        barPercentage:0.7,
        categoryPercentage:0.8
      },
      { label:'손익분기점', data:Array(20).fill(breakeven), type:'line', borderColor:'red', borderDash:[6,4], borderWidth:2, pointRadius:0, order: 0 }
    ]
  },
  options: {
    ...commonOpts,
    plugins: { tooltip: { enabled: true, callbacks: { label: ctx => ctx.raw.toLocaleString() + ' 원' } }, legend: { display: false } }
  }
});
</script>
</body>
</html>
