<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>에너지 발전 영향 및 온실가스 감축 시뮬레이션</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
  body {
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
    background: #f8fafc;
    margin: 0;
    padding: 0; 
    display: flex;
    justify-content: center;
    align-items: center; 
    min-height: 100vh; 
  }
  .main-container {
    display: flex;
    flex-direction: column; 
    gap: 15px; 
    max-width: 380px; 
    width: 100%;
    align-items: center;
    padding: 15px 10px; 
    box-sizing: border-box; 
  }
  .chart-box {
    background: white;
    border-radius: 12px; 
    padding: 15px; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
    width: 100%; 
    min-width: auto; 
    position: relative; /* ✅ 차트 박스가 중앙 텍스트의 기준점이 됨 */
  }

  h2 {
    text-align: center;
    color: #1d3557;
    margin-bottom: 12px; 
    font-size: 1.1em; 
    font-weight: 700;
  }
  .button-group {
    text-align: center;
    margin-top: 10px; 
  }
  button {
    padding: 6px 10px; 
    margin: 0 3px;
    background: #457b9d;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.8em; 
    transition: background 0.3s;
  }
  button:hover { background: #1d3557; }
  
  /* 중앙 강조 정보 스타일 (도넛 차트 전용) */
  #center-text {
      position: absolute;
      /* ✅ 정확히 차트 캔버스가 있는 영역의 중앙을 맞추도록 조정 */
      top: calc(50% + 20px); /* H2의 마진(12px)과 차트박스의 패딩(15px)만큼 보정 */
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none; 
      text-align: center;
      font-weight: 700;
      line-height: 1.2; 
      color: #1d3557;
      opacity: 0; 
      transition: opacity 0.5s ease-in-out;
      width: 80%; 
      /* 배경 투명화 및 z-index 설정은 Chart.js 기본 동작에 맡김 */
  }
  #center-text.visible { opacity: 1; }
  .value-gwh { font-size: 1.1em; color: #4caf50; display: block; margin-top: 3px; } 

  /* 기여도 차트 하단 정보 */
  .reduction-info {
      text-align: center;
      font-size: 0.85em; 
      font-weight: 700;
      color: #1d3557;
      margin-top: 8px; 
  }
  .info-value {
      color: #e76f51; 
      font-size: 1em; 
      margin-left: 4px; 
  }
  /* 캔버스 높이 고정 (사이즈 축소) */
  #powerChart, #contributionChart {
      height: 230px !important; 
  }

  /* 좁은 화면에서의 높이 유지 */
  @media (max-width: 420px) { 
    #powerChart, #contributionChart {
      height: 250px !important; 
    }
  }
</style>
</head>
<body>

<div class="main-container">
    <div id="doughnut-chart-area" class="chart-box">
        <h2>에너지원별 발전량 영향 분석</h2>
        <div style="position: relative;">
            <canvas id="powerChart"></canvas>
            <div id="center-text"></div> </div>
        <div class="button-group">
            <button id="show-before">기존 현황 보기</button>
            <button id="show-after">태양광 발전량 추가</button>
        </div>
    </div>

    <div id="contribution-chart-area" class="chart-box">
        <h2>인천시 2030년 목표 대비 감축 기여도</h2>
        <canvas id="contributionChart"></canvas>
        
        <div class="reduction-info">
            목표 감축량 (2018년 대비 31.0%): <span id="target-reduction-amount" class="info-value">0</span> ktCO2e
        </div>
        <div class="reduction-info">
            태양광 예상 감축량: <span id="reduction-amount" class="info-value">0</span> ktCO2e
        </div>
    </div>
</div>

<script>
// Chart.js Datelabels 플러그인 등록
Chart.register(ChartDataLabels);

// ========================================================
// 공통 데이터 및 계산
// ========================================================

const emission2018 = 15894.70; 
const INCHEON_TARGET_RATE = 0.31; 
const reductionTarget_kt = emission2018 * INCHEON_TARGET_RATE; 

const solarGenerationKWh = 1930712676 + 55172575 + 16546822; 
const REDUCTION_FACTOR_KWH = 0.4781; 
const KILOGRAMS_TO_KILOTONNES = 1000000;
const totalReduction_kt = (solarGenerationKWh * REDUCTION_FACTOR_KWH) / KILOGRAMS_TO_KILOTONNES; 

const remainingReductionNeeded = reductionTarget_kt - totalReduction_kt;


// ========================================================
// 1. 왼쪽 에너지원 도넛 차트 (powerChart)
// ========================================================

const dataBefore = {원자력: 188754, 석탄: 167160, LNG: 167205, 신재생: 63155, 유류: 1204, 양수: 4677, 기타: 3413};
const newRenewableEnergy = 65157.432073; 
const increaseValue = newRenewableEnergy - dataBefore.신재생; 
const dataAfter = {원자력: dataBefore.원자력, 석탄: dataBefore.석탄, LNG: dataBefore.LNG, 신재생: newRenewableEnergy, 유류: dataBefore.유류, 양수: dataBefore.양수, 기타: dataBefore.기타};
const labels = Object.keys(dataBefore);
const initialData = Object.values(dataBefore);
const finalData = Object.values(dataAfter);
const backgroundColors = ['#2a9d8f', '#e9c46a', '#f4a261', '#264653', '#e76f51', '#50a0d0', '#cccccc'];
const renewableIndex = labels.indexOf('신재생'); 

const ctx_doughnut = document.getElementById('powerChart').getContext('2d');
let powerChart = new Chart(ctx_doughnut, {
  type: 'doughnut',
  data: {
    labels: labels,
    datasets: [{
      data: initialData,
      backgroundColor: backgroundColors,
      borderWidth: 1,
      offset: labels.map((_, i) => (i === renewableIndex) ? 5 : 0) 
    }]
  },
  options: {
    responsive: true, cutout: '70%', animation: { duration: 1000, easing: 'easeInOutQuint' },
    plugins: {
      legend: { position: 'top', labels: { font: { size: 11 } } }, 
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.label || '';
            if (label) { label += ': '; }
            const value = context.parsed;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = ((value / total) * 100).toFixed(4) + '%';
            
            let tooltipText = label + value.toLocaleString(undefined, {maximumFractionDigits: 4}) + ' GWh (' + percentage + ')';

            if (context.label === '신재생' && powerChart.data.datasets[0].data === finalData) {
                 tooltipText += ` (증가량: +${increaseValue.toLocaleString(undefined, {maximumFractionDigits: 4})} GWh)`;
            }
            return tooltipText;
          }
        }
      },
      datalabels: { display: false }
    }
  }
});

function updateChart(state) {
  const dataSet = powerChart.data.datasets[0];
  const centerTextElement = document.getElementById('center-text');
  
  if (state === 'after') {
      dataSet.data = finalData;
      dataSet.offset = labels.map((_, i) => i === renewableIndex ? 20 : 0); 
      const newColors = [...backgroundColors];
      newColors[renewableIndex] = '#4caf50'; 
      dataSet.backgroundColor = newColors;
      
      // ✅ 중앙 텍스트 내용 업데이트
      centerTextElement.innerHTML = `
          <span class="title">태양광 발전 효과</span><br>
          <span class="value-gwh">+${increaseValue.toLocaleString(undefined, {maximumFractionDigits: 4})} GWh</span>
      `;
      centerTextElement.classList.add('visible'); 
  } else {
      dataSet.data = initialData;
      dataSet.offset = labels.map((_, i) => i === renewableIndex ? 5 : 0); 
      dataSet.backgroundColor = backgroundColors;
      centerTextElement.classList.remove('visible'); 
  }
  
  powerChart.update(); 
}

document.getElementById('show-before').addEventListener('click', () => updateChart('before'));
document.getElementById('show-after').addEventListener('click', () => updateChart('after'));
updateChart('after'); // 초기 상태를 'after'로 설정하여 태양광 발전 효과가 보이도록


// ========================================================
// 2. 오른쪽 목표 기여 원형 차트 (contributionChart)
// ========================================================

const contributionDoughnutData = {
    labels: ['태양광 감축 기여', '추가 감축 목표량'],
    datasets: [{
        data: [totalReduction_kt, remainingReductionNeeded],
        backgroundColor: ['#4caf50', '#e9c46a'], 
        borderWidth: 1
    }]
};

new Chart(document.getElementById('contributionChart'), {
    type: 'doughnut',
    data: contributionDoughnutData,
    options: {
        responsive: true,
        cutout: '0%', /* 원형 차트 (Pie Chart) */
        plugins: {
            legend: {
                position: 'top',
                labels: { font: { size: 11 } } 
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) { label += ': '; }
                        const value = context.parsed;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = (value / total * 100).toFixed(2) + '%';
                        return label + value.toLocaleString(undefined, {maximumFractionDigits: 2}) + ' ktCO2e (' + percentage + ')';
                    }
                }
            },
            datalabels: {
                color: '#fff',
                formatter: (value, context) => {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = (value / total * 100).toFixed(1) + '%';
                    if (value / total * 100 < 5) return ''; 
                    return percentage;
                },
                font: {
                    weight: 'bold',
                    size: 12
                }
            }
        }
    }
});

// 하단 정보 업데이트
document.getElementById('target-reduction-amount').textContent = reductionTarget_kt.toLocaleString(undefined, {maximumFractionDigits: 2});
document.getElementById('reduction-amount').textContent = totalReduction_kt.toLocaleString(undefined, {maximumFractionDigits: 2});
</script>

</body>
</html>
