<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ì—ë„ˆì§€ ë°œì „ ì˜í–¥ ë° ì˜¨ì‹¤ê°€ìŠ¤ ê°ì¶• ì‹œë®¬ë ˆì´ì…˜</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
  body {
    font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
    background: #f8fafc;
    margin: 0;
    padding: 0; 
    display: flex;
    justify-content: center;
    align-items: center; 
    min-height: 100vh; 
  }
  .main-container {
    display: flex;
    flex-direction: column; 
    gap: 15px;
    max-width: 400px;
    width: 100%;
    align-items: center;
    padding: 15px 10px;
    box-sizing: border-box; 
  }
  .chart-box {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
    width: 100%; 
  }

  h2 {
    text-align: center;
    color: #1d3557;
    margin-bottom: 12px; 
    font-size: 1.1em;
    font-weight: 700;
  }

  .button-group {
    text-align: center;
    margin-top: 10px; 
  }
  button {
    padding: 6px 10px;
    margin: 0 3px;
    background: #457b9d;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.8em; 
    transition: background 0.3s;
  }
  button:hover { background: #1d3557; }

  #powerChart {
      height: 290px !important; /* ğŸ”¹ ë„ë„› ê·¸ë˜í”„ í‚¤ì›€ */
  }
  #contributionChart {
      height: 230px !important;
  }

  /* âœ… í•˜ë‹¨ ì •ë³´ í•œ ì¤„ ì •ë ¬ */
  .reduction-info {
      text-align: center;
      font-size: 0.85em;
      font-weight: 700;
      color: #1d3557;
      margin-top: 6px;
      white-space: nowrap; /* ğŸ”¹ ì¤„ë°”ê¿ˆ ë°©ì§€ */
  }
  .info-value {
      color: #e76f51; 
      font-size: 1em;
      margin-left: 4px; 
  }

  @media (max-width: 420px) { 
    #powerChart { height: 310px !important; }
    #contributionChart { height: 250px !important; }
  }
</style>
</head>
<body>

<div class="main-container">
    <div id="doughnut-chart-area" class="chart-box">
        <h2>ì—ë„ˆì§€ì›ë³„ ë°œì „ëŸ‰ ì˜í–¥ ë¶„ì„</h2>
        <canvas id="powerChart"></canvas>
        <div class="button-group">
            <button id="show-before">ê¸°ì¡´ í˜„í™© ë³´ê¸°</button>
            <button id="show-after">íƒœì–‘ê´‘ ë°œì „ëŸ‰ ì¶”ê°€</button>
        </div>
    </div>

    <div id="contribution-chart-area" class="chart-box">
        <h2>ì¸ì²œì‹œ 2030ë…„ ëª©í‘œ ëŒ€ë¹„ ê°ì¶• ê¸°ì—¬ë„</h2>
        <canvas id="contributionChart"></canvas>
        
        <div class="reduction-info">
            ëª©í‘œ ê°ì¶•ëŸ‰ (2018ë…„ ëŒ€ë¹„ 31.0%): <span id="target-reduction-amount" class="info-value">0</span> ktCO2e
        </div>
        <div class="reduction-info">
            íƒœì–‘ê´‘ ì˜ˆìƒ ê°ì¶•ëŸ‰: <span id="reduction-amount" class="info-value">0</span> ktCO2e
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);

// ================================
// ë°ì´í„°
// ================================
const emission2018 = 15894.70;
const INCHEON_TARGET_RATE = 0.31;
const reductionTarget_kt = emission2018 * INCHEON_TARGET_RATE;

const solarGenerationKWh = 1930712676 + 55172575 + 16546822;
const REDUCTION_FACTOR_KWH = 0.4781;
const KILOGRAMS_TO_KILOTONNES = 1000000;
const totalReduction_kt = (solarGenerationKWh * REDUCTION_FACTOR_KWH) / KILOGRAMS_TO_KILOTONNES;
const remainingReductionNeeded = reductionTarget_kt - totalReduction_kt;

// ================================
// ë„ë„› ì°¨íŠ¸ ë°ì´í„°
// ================================
const dataBefore = {ì›ìë ¥: 188754, ì„íƒ„: 167160, LNG: 167205, ì‹ ì¬ìƒ: 63155, ìœ ë¥˜: 1204, ì–‘ìˆ˜: 4677, ê¸°íƒ€: 3413};
const newRenewableEnergy = 65157.432073;
const increaseValue = newRenewableEnergy - dataBefore.ì‹ ì¬ìƒ;
const dataAfter = { ...dataBefore, ì‹ ì¬ìƒ: newRenewableEnergy };
const labels = Object.keys(dataBefore);
const initialData = Object.values(dataBefore);
const finalData = Object.values(dataAfter);
const backgroundColors = ['#2a9d8f', '#e9c46a', '#f4a261', '#264653', '#e76f51', '#50a0d0', '#cccccc'];
const renewableIndex = labels.indexOf('ì‹ ì¬ìƒ');

const ctx_doughnut = document.getElementById('powerChart').getContext('2d');

// âœ… ì»¤ìŠ¤í…€ í”ŒëŸ¬ê·¸ì¸ (v4 í˜¸í™˜)
const centerTextPlugin = {
  id: 'centerTextPlugin',
  beforeDraw(chart) {
    const { ctx, chartArea: { width, height } } = chart;
    const centerX = width / 2;
    const centerY = height / 2 + 12;
    const dataSet = chart.data.datasets[0].data;
    if (dataSet !== finalData) return; // "after" ìƒíƒœì¼ ë•Œë§Œ í‘œì‹œ
    ctx.save();

    ctx.font = '600 14px Pretendard';
    ctx.fillStyle = '#1d3557';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('íƒœì–‘ê´‘ ë°œì „ íš¨ê³¼', centerX, centerY - 26);

    ctx.font = '700 19px Pretendard';
    ctx.fillStyle = '#4caf50';
    ctx.fillText(`+${increaseValue.toLocaleString(undefined, { maximumFractionDigits: 1 })} GWh`, centerX, centerY + 3);

    ctx.restore();
  }
};

let powerChart = new Chart(ctx_doughnut, {
  type: 'doughnut',
  data: {
    labels: labels,
    datasets: [{
      data: initialData,
      backgroundColor: backgroundColors,
      borderWidth: 1,
      offset: labels.map((_, i) => (i === renewableIndex) ? 5 : 0)
    }]
  },
  options: {
    responsive: true,
    cutout: '68%',
    animation: { duration: 1000, easing: 'easeInOutQuint' },
    plugins: {
      legend: { position: 'top', labels: { font: { size: 12 } } },
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.label || '';
            if (label) { label += ': '; }
            const value = context.parsed;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = ((value / total) * 100).toFixed(2) + '%';
            let tooltipText = label + value.toLocaleString(undefined, {maximumFractionDigits: 2}) + ' GWh (' + percentage + ')';
            if (context.label === 'ì‹ ì¬ìƒ' && powerChart.data.datasets[0].data === finalData) {
              tooltipText += ` (ì¦ê°€ëŸ‰: +${increaseValue.toLocaleString(undefined, {maximumFractionDigits: 2})} GWh)`;
            }
            return tooltipText;
          }
        }
      },
      datalabels: { display: false }
    }
  },
  plugins: [centerTextPlugin]
});

function updateChart(state) {
  const dataSet = powerChart.data.datasets[0];
  if (state === 'after') {
    dataSet.data = finalData;
    dataSet.offset = labels.map((_, i) => i === renewableIndex ? 20 : 0);
    const newColors = [...backgroundColors];
    newColors[renewableIndex] = '#4caf50';
    dataSet.backgroundColor = newColors;
  } else {
    dataSet.data = initialData;
    dataSet.offset = labels.map((_, i) => i === renewableIndex ? 5 : 0);
    dataSet.backgroundColor = backgroundColors;
  }
  powerChart.update();
}

document.getElementById('show-before').addEventListener('click', () => updateChart('before'));
document.getElementById('show-after').addEventListener('click', () => updateChart('after'));
updateChart('after');

// ================================
// ê°ì¶• ê¸°ì—¬ë„ ì°¨íŠ¸
// ================================
const contributionDoughnutData = {
  labels: ['íƒœì–‘ê´‘ ê°ì¶• ê¸°ì—¬', 'ì¶”ê°€ ê°ì¶• ëª©í‘œëŸ‰'],
  datasets: [{
      data: [totalReduction_kt, remainingReductionNeeded],
      backgroundColor: ['#4caf50', '#e9c46a'], 
      borderWidth: 1
  }]
};

new Chart(document.getElementById('contributionChart'), {
  type: 'doughnut',
  data: contributionDoughnutData,
  options: {
    responsive: true,
    cutout: '0%',
    plugins: {
      legend: { position: 'top', labels: { font: { size: 12 } } },
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.label || '';
            if (label) { label += ': '; }
            const value = context.parsed;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = (value / total * 100).toFixed(2) + '%';
            return label + value.toLocaleString(undefined, {maximumFractionDigits: 2}) + ' ktCO2e (' + percentage + ')';
          }
        }
      },
      datalabels: {
        color: '#fff',
        formatter: (value, context) => {
          const total = context.dataset.data.reduce((a, b) => a + b, 0);
          const percentage = (value / total * 100).toFixed(1) + '%';
          if (value / total * 100 < 5) return ''; 
          return percentage;
        },
        font: { weight: 'bold', size: 12 }
      }
    }
  }
});

// í•˜ë‹¨ ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
document.getElementById('target-reduction-amount').textContent = reductionTarget_kt.toLocaleString(undefined, {maximumFractionDigits: 2});
document.getElementById('reduction-amount').textContent = totalReduction_kt.toLocaleString(undefined, {maximumFractionDigits: 2});
</script>
</body>
</html>
